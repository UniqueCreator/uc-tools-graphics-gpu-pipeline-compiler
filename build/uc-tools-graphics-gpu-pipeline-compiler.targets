<?xml version="1.0" encoding="utf-8"?>
<Project ToolVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

    <PropertyGroup>
        <AutoGeneratedGraphicsPipelineStateObjects Condition="$(AutoGeneratedGraphicsPipelineStateObjects) == ''">$(MSBuildThisFileDirectory)autogen\$(Platform)\$(ProjectName)shaders\</AutoGeneratedGraphicsPipelineStateObjects>
    </PropertyGroup>

    <ItemDefinitionGroup>
        <GraphicsPipelineStateObject>
            <EntryPointName>main</EntryPointName>
        </GraphicsPipelineStateObject>
    </ItemDefinitionGroup>

    <Target Name="UcToolsGenerateGraphicsItems" Condition="'@(GraphicsPipelineStateObject)' != ''">
        <CreateItem Include = "@(GraphicsPipelineStateObject)" PreserveExistingMetadata="True" AdditionalMetadata="CPPHeaderOutput=$(AutoGeneratedGraphicsPipelineStateObjects)%(GraphicsPipelineStateObject.EntryPointName).h;CPPOutput=$(AutoGeneratedGraphicsPipelineStateObjects)%(GraphicsPipelineStateObject.EntryPointName).cpp">
            <Output TaskParameter ="Include" ItemName = "GraphicsPipelineStateObjectBuilds"/>
        </CreateItem>
    </Target>   

    <Target Name="UcToolsMakeDirsGraphics" DependsOnTargets="UcToolsGenerateGraphicsItems" Condition="'@(GraphicsPipelineStateObject)' != ''">

        <ItemGroup Condition="'@(GraphicsPipelineStateObject)'!=''">
          <Outputs Include="@(GraphicsPipelineStateObjectBuilds->Metadata('CPPHeaderOutput')->Distinct())" />
          <Outputs Include="@(GraphicsPipelineStateObjectBuilds->Metadata('CPPOutput')->Distinct())" />
          <DirsToMake Include="@(Outputs->DirectoryName())" />
        </ItemGroup>

        <MakeDir Directories="@(DirsToMake)" />

        <ItemGroup>
            <DirsToMake Remove="@(DirsToMake)" />
        </ItemGroup>
    </Target>

    <Target Name="UcToolsGenerateGraphics" DependsOnTargets="UcToolsMakeDirsGraphics;UcToolsGenerateGraphicsItems" Inputs="@(GraphicsPipelineStateObjectBuilds)" Condition="'@(GraphicsPipelineStateObject)' != ''" Outputs="%(GraphicsPipelineStateObjectBuilds.CPPHeaderOutput);%(GraphicsPipelineStateObjectBuilds.CPPOutput)">
        <Exec Command="$(UCToolsGraphicsPipelineTool1) --main %(GraphicsPipelineStateObjectBuilds.EntryPointName) --file %(GraphicsPipelineStateObjectBuilds.FullPath) --cpp %(GraphicsPipelineStateObjectBuilds.CPPOutput) --header %(GraphicsPipelineStateObjectBuilds.CPPHeaderOutput)" Outputs="%(GraphicsPipelineStateObjectBuilds.CPPOutput)" >
            <Output TaskParameter="Outputs" ItemName="ClCompile" />
        </Exec>     
    </Target>
    
    <Target Name="UcToolsGenerateGraphicsPrint" DependsOnTargets="UcToolsGenerateGraphics" Condition="'@(GraphicsPipelineStateObject)' != ''" >
        <Message Text="@(ClCompile)"/>
    </Target>

    <PropertyGroup>
        <PrepareForBuildDependsOn>
            UcToolsMakeDirsGraphics;
            $(PrepareForBuildBuildDependsOn)
        </PrepareForBuildDependsOn>

        <BeforeClCompileTargets>
            UcToolsGenerateGraphics;
            $(BeforeClCompileTargets)
        </BeforeClCompileTargets>
    </PropertyGroup>

</Project>